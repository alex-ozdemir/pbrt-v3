syntax = 'proto3';

import "google/protobuf/any.proto";

package pbrt.protobuf;

message Point2f {
    float x = 1;
    float y = 2;
}

message Point2i {
    int32 x = 1;
    int32 y = 2;
}

message Point3f {
    float x = 1;
    float y = 2;
    float z = 3;
}

message Vector3f {
    float x = 1;
    float y = 2;
    float z = 3;
}

message Normal3f {
    float x = 1;
    float y = 2;
    float z = 3;
}

message Matrix {
    repeated float m = 1;
}

message AnimatedTransform {
    Matrix start_transform = 1;
    Matrix end_transform = 2;
    float start_time = 3;
    float end_time = 4;
}

message Bounds2i {
    Point2i point_min = 1;
    Point2i point_max = 2;
}

message Bounds3f {
    Point3f point_min = 1;
    Point3f point_max = 2;
}

message TransformedPrimitive {
    AnimatedTransform transform = 1;
    int64 root_ref = 2;
}

// Shapes

message TriangleMesh {
    int32 n_triangles = 1;
    int32 n_vertices = 2;
    repeated int32 vertex_indices = 3;
    repeated Point3f p = 4;
    repeated Normal3f n = 5;  // Normal3f
    repeated Vector3f s = 6;  // Vector3f
    repeated Point2f uv = 7;
}

message Triangle {
    int64 mesh_id = 1;
    int64 tri_number = 2;
}

message BVHNode {
    Bounds3f bounds = 1;
    int64 left_ref = 2;
    int64 right_ref = 3;
    uint32 axis = 4;

    repeated TransformedPrimitive transformed_primitives = 7;
    repeated Triangle triangles = 8;
}

// RayState

message RGBSpectrum {
    repeated float c = 1;
}

message RayDifferential {
    Point3f o = 1;
    Vector3f d = 2;
    float t_max = 3;
    float time = 4;

    bool has_differentials = 5;
    Point3f rx_origin = 6;
    Point3f ry_origin = 7;
    Vector3f rx_direction = 8;
    Vector3f ry_direction = 9;
}

message VisitNode {
    uint32 treelet = 1;
    uint32 node = 2;
    Matrix transform = 3;
}

message RayState {
    uint64 sample_id = 1;
    int64 sample_num = 2;
    Point2i sample_pixel = 3;
    RayDifferential ray = 4;
    repeated VisitNode to_visit = 5;
    VisitNode hit = 6;
    RGBSpectrum beta = 7;
    RGBSpectrum Ld = 8;
    uint32 bounces = 9;
    uint32 remaining_bounces = 10;
    bool is_shadow_ray = 11;
}

// Lights

message DistantLight {
    Matrix light_to_world = 1;
    RGBSpectrum L = 2;
    Vector3f dir = 3;
}

enum LightType { LIGHT_DISTANT = 0; }

message Light {
    LightType type = 1;
    google.protobuf.Any data = 2;
}
